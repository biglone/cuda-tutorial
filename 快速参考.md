# CUDA å¿«é€Ÿå‚è€ƒå¡

## ğŸš€ ç¼–è¯‘è¿è¡Œ

```bash
# ç¼–è¯‘
nvcc filename.cu -o output

# ç¼–è¯‘å¹¶è¿è¡Œ
nvcc filename.cu -o output && ./output
```

---

## ğŸ“‹ åŸºæœ¬æ¨¡æ¿

```cuda
#include <stdio.h>
#include <cuda_runtime.h>

// æ ¸å‡½æ•°
__global__ void myKernel(float *data, int n) {
    int tid = threadIdx.x + blockIdx.x * blockDim.x;
    if (tid < n) {
        // ä½ çš„ä»£ç 
        data[tid] = data[tid] * 2;
    }
}

int main() {
    int N = 1000;
    int size = N * sizeof(float);

    // 1. åˆ†é…ä¸»æœºå†…å­˜
    float *h_data = (float*)malloc(size);

    // 2. åˆ†é…è®¾å¤‡å†…å­˜
    float *d_data;
    cudaMalloc(&d_data, size);

    // 3. æ•°æ®ä¼ è¾“ Hâ†’D
    cudaMemcpy(d_data, h_data, size, cudaMemcpyHostToDevice);

    // 4. å¯åŠ¨æ ¸å‡½æ•°
    int threads = 256;
    int blocks = (N + threads - 1) / threads;
    myKernel<<<blocks, threads>>>(d_data, N);

    // 5. åŒæ­¥
    cudaDeviceSynchronize();

    // 6. æ•°æ®ä¼ è¾“ Dâ†’H
    cudaMemcpy(h_data, d_data, size, cudaMemcpyDeviceToHost);

    // 7. é‡Šæ”¾å†…å­˜
    cudaFree(d_data);
    free(h_data);

    return 0;
}
```

---

## ğŸ”‘ å…³é”®æ¦‚å¿µé€Ÿè®°

### çº¿ç¨‹ç´¢å¼•è®¡ç®—

```cuda
// 1D
int tid = threadIdx.x + blockIdx.x * blockDim.x;

// 2D
int x = threadIdx.x + blockIdx.x * blockDim.x;
int y = threadIdx.y + blockIdx.y * blockDim.y;

// 2D è½¬ 1Dï¼ˆç”¨äºæ•°ç»„è®¿é—®ï¼‰
int tid = y * width + x;
```

### ç½‘æ ¼é…ç½®

```cuda
// 1D é…ç½®
int threads = 256;
int blocks = (N + threads - 1) / threads;
kernel<<<blocks, threads>>>();

// 2D é…ç½®
dim3 threads(16, 16);  // 16Ã—16 = 256 ä¸ªçº¿ç¨‹
dim3 blocks((width + 15) / 16, (height + 15) / 16);
kernel<<<blocks, threads>>>();
```

---

## ğŸ› ï¸ å¸¸ç”¨å‡½æ•°

### å†…å­˜æ“ä½œ

```cuda
// åˆ†é…
cudaMalloc(void **ptr, size_t size)

// å¤åˆ¶
cudaMemcpy(dst, src, size, cudaMemcpyHostToDevice)    // CPU â†’ GPU
cudaMemcpy(dst, src, size, cudaMemcpyDeviceToHost)    // GPU â†’ CPU
cudaMemcpy(dst, src, size, cudaMemcpyDeviceToDevice)  // GPU â†’ GPU

// æ¸…é›¶
cudaMemset(void *ptr, 0, size)

// é‡Šæ”¾
cudaFree(void *ptr)
```

### åŒæ­¥ä¸é”™è¯¯

```cuda
// ç­‰å¾… GPU å®Œæˆ
cudaDeviceSynchronize()

// è·å–é”™è¯¯
cudaError_t err = cudaGetLastError()
printf("%s\n", cudaGetErrorString(err))
```

### æ€§èƒ½è®¡æ—¶

```cuda
cudaEvent_t start, stop;
cudaEventCreate(&start);
cudaEventCreate(&stop);

cudaEventRecord(start);
// ... GPU æ“ä½œ ...
cudaEventRecord(stop);

cudaEventSynchronize(stop);
float ms;
cudaEventElapsedTime(&ms, start, stop);

cudaEventDestroy(start);
cudaEventDestroy(stop);
```

---

## ğŸ¯ å‡½æ•°é™å®šç¬¦

| é™å®šç¬¦ | åœ¨å“ªæ‰§è¡Œ | ä»å“ªè°ƒç”¨ | ç”¨é€” |
|--------|---------|---------|------|
| `__global__` | GPU | CPU | æ ¸å‡½æ•° |
| `__device__` | GPU | GPU | è®¾å¤‡å‡½æ•° |
| `__host__` | CPU | CPU | æ™®é€šå‡½æ•°ï¼ˆé»˜è®¤ï¼‰|

---

## ğŸ“Š å†…ç½®å˜é‡

| å˜é‡ | å«ä¹‰ |
|------|------|
| `threadIdx.x/y/z` | çº¿ç¨‹åœ¨å—å†…çš„ç´¢å¼• |
| `blockIdx.x/y/z` | å—åœ¨ç½‘æ ¼ä¸­çš„ç´¢å¼• |
| `blockDim.x/y/z` | å—çš„å¤§å° |
| `gridDim.x/y/z` | ç½‘æ ¼çš„å¤§å° |

---

## âš ï¸ å¸¸è§é™·é˜±

### âŒ é”™è¯¯åšæ³•

```cuda
// 1. å¿˜è®°è¾¹ç•Œæ£€æŸ¥
__global__ void kernel(float *data, int n) {
    int tid = threadIdx.x + blockIdx.x * blockDim.x;
    data[tid] = ...;  // å¯èƒ½è¶Šç•Œï¼
}

// 2. å¿˜è®°åŒæ­¥
kernel<<<blocks, threads>>>();
// ç«‹å³ä½¿ç”¨ç»“æœ - é”™è¯¯ï¼GPU å¯èƒ½è¿˜æ²¡å®Œæˆ

// 3. æ··æ·†ä¸»æœºå’Œè®¾å¤‡æŒ‡é’ˆ
float *d_data;
cudaMalloc(&d_data, size);
d_data[0] = 1.0;  // é”™è¯¯ï¼ä¸»æœºä¸èƒ½è®¿é—®è®¾å¤‡å†…å­˜

// 4. å¿˜è®°æ£€æŸ¥é”™è¯¯
cudaMalloc(&d_data, size);  // å¦‚æœå¤±è´¥äº†å‘¢ï¼Ÿ
```

### âœ… æ­£ç¡®åšæ³•

```cuda
// 1. æ€»æ˜¯æ£€æŸ¥è¾¹ç•Œ
__global__ void kernel(float *data, int n) {
    int tid = threadIdx.x + blockIdx.x * blockDim.x;
    if (tid < n) {
        data[tid] = ...;  // å®‰å…¨
    }
}

// 2. åŒæ­¥åå†ä½¿ç”¨ç»“æœ
kernel<<<blocks, threads>>>();
cudaDeviceSynchronize();
// ç°åœ¨å¯ä»¥å®‰å…¨ä½¿ç”¨ç»“æœ

// 3. æ­£ç¡®ä½¿ç”¨å†…å­˜
float *d_data;
cudaMalloc(&d_data, size);
cudaMemcpy(d_data, h_data, size, cudaMemcpyHostToDevice);

// 4. æ£€æŸ¥é”™è¯¯
#define CHECK_CUDA(call) { \
    cudaError_t err = call; \
    if (err != cudaSuccess) { \
        printf("é”™è¯¯: %s\n", cudaGetErrorString(err)); \
        exit(1); \
    } \
}

CHECK_CUDA(cudaMalloc(&d_data, size));
```

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### threadsPerBlock é€‰æ‹©

```cuda
// æ¨èå€¼ï¼ˆå¿…é¡»æ˜¯ 32 çš„å€æ•°ï¼‰
128, 256, 512

// æœ€å¤§å€¼ï¼ˆå–å†³äºç¡¬ä»¶ï¼Œé€šå¸¸ 1024ï¼‰
```

### æœ€å°åŒ–å†…å­˜ä¼ è¾“

```
ä¼ è¾“å¼€é”€ >> è®¡ç®—å¼€é”€
```

**ç­–ç•¥**ï¼š
- å°½é‡åœ¨ GPU ä¸Šå®Œæˆæ‰€æœ‰è®¡ç®—
- æ‰¹é‡ä¼ è¾“æ•°æ®
- è€ƒè™‘ä½¿ç”¨ Unified Memory

---

## ğŸ” è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹ GPU ä¿¡æ¯
nvidia-smi

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
nvidia-smi -q

# ç›‘æ§ GPU
watch -n 1 nvidia-smi

# CUDA ç‰ˆæœ¬
nvcc --version

# æŸ¥çœ‹è®¾å¤‡å±æ€§
deviceQuery  # CUDA samples ä¸­çš„å·¥å…·
```

---

## ğŸ“– å­¦ä¹ è·¯å¾„

```
ç¬¬1é˜¶æ®µï¼šåŸºç¡€
â”œâ”€ hello_cuda.cu         â†’ æ ¸å‡½æ•°å’Œçº¿ç¨‹
â”œâ”€ kernel_basics.cu      â†’ å¤šç»´é…ç½®
â”œâ”€ memory_management.cu  â†’ å†…å­˜æ“ä½œ
â””â”€ vector_add.cu         â†’ å®Œæ•´æµç¨‹

ç¬¬2é˜¶æ®µï¼šä¼˜åŒ–
â”œâ”€ å…±äº«å†…å­˜
â”œâ”€ å†…å­˜åˆå¹¶
â””â”€ çº¿ç¨‹åŒæ­¥

ç¬¬3é˜¶æ®µï¼šé«˜çº§
â”œâ”€ CUDA Streams
â”œâ”€ Unified Memory
â””â”€ åŠ¨æ€å¹¶è¡Œ

ç¬¬4é˜¶æ®µï¼šåº”ç”¨
â”œâ”€ çŸ©é˜µä¹˜æ³•
â”œâ”€ å›¾åƒå¤„ç†
â””â”€ æ·±åº¦å­¦ä¹ 
```

---

## ğŸ†˜ é—®é¢˜æ’æŸ¥

| ç—‡çŠ¶ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ³• |
|------|---------|---------|
| `nvcc: command not found` | CUDA æœªå®‰è£… | å®‰è£… CUDA toolkit |
| `illegal memory access` | æ•°ç»„è¶Šç•Œ | æ£€æŸ¥è¾¹ç•Œæ¡ä»¶ |
| ç»“æœä¸æ­£ç¡® | æœªåŒæ­¥ | åŠ  `cudaDeviceSynchronize()` |
| ç¼–è¯‘é”™è¯¯ | æ–‡ä»¶åç¼€é”™è¯¯ | ä½¿ç”¨ `.cu` è€Œé `.c` |
| GPU æ— è¾“å‡º | æ ¸å‡½æ•°é”™è¯¯ | æ£€æŸ¥ `cudaGetLastError()` |

---

## ğŸ“ è·å–å¸®åŠ©

```cuda
// æ‰“å° CUDA é”™è¯¯
cudaError_t err = cudaGetLastError();
if (err != cudaSuccess) {
    printf("CUDA é”™è¯¯: %s\n", cudaGetErrorString(err));
}

// æ‰“å°è®¾å¤‡ä¿¡æ¯
int deviceCount;
cudaGetDeviceCount(&deviceCount);
for (int i = 0; i < deviceCount; i++) {
    cudaDeviceProp prop;
    cudaGetDeviceProperties(&prop, i);
    printf("è®¾å¤‡ %d: %s\n", i, prop.name);
}
```

---

**è®°ä½**ï¼šä»ç®€å•å¼€å§‹ï¼Œé€æ­¥ä¼˜åŒ–ï¼Œå¤šå®è·µï¼ ğŸš€
